<!doctype>
<html>

<head>
<!-- <script type="text/javascript" src="../dist/web3.js"></script> -->

<!-- Latest compiled and minified CSS -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-table/1.12.1/bootstrap-table.min.css">
<script src="../dist/ethereumjs-tx.js"></script>
<script src="https://cdn.jsdelivr.net/gh/ethereum/web3.js/dist/web3.min.js"></script>

<script type="text/javascript">
    
    // 0x26cb0417eAd2D286E8a9d735CcE2a22872ab4e41
    // 4f973b75c3ce33fbd13d5b14400b94e870ebbc9467cf0e06f2aea20215af8163

    var Web3 = require('web3');



    let web3;
    if (typeof web3 !== 'undefined') {
        web3 = new Web3(web3.currentProvider);
    } else {
        web3 = new Web3(new Web3.providers.HttpProvider('http://localhost:8545'));
        //web3 = new Web3();
    }

    console.log('accounts');
    web3.eth.getAccounts(console.log);

    /*
    var compiled = web3.eth.compile.solidity(source);
    var code = compiled.code;
    // contract json abi, this is autogenerated using solc CLI
    var abi = compiled.info.abiDefinition;
    */

    var myContract;
    var lotteryContract = web3.eth.contract([{"constant":true,"inputs":[],"name":"manager","outputs":[{"name":"","type":"address"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[],"name":"pickWinner","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":true,"inputs":[],"name":"getPlayers","outputs":[{"name":"","type":"address[]"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[],"name":"enter","outputs":[],"payable":true,"stateMutability":"payable","type":"function"},{"constant":true,"inputs":[{"name":"","type":"uint256"}],"name":"players","outputs":[{"name":"","type":"address"}],"payable":false,"stateMutability":"view","type":"function"},{"inputs":[],"payable":false,"stateMutability":"nonpayable","type":"constructor"}]);

    var contract_address = '0xB166DE9595a42fdE8Ce3572A31Ae0a484C33aaEA';
    var lotteryContractInstance = lotteryContract.at(contract_address);
    /*
    function createExampleContract() {
        // hide create button
        document.getElementById('create').style.visibility = 'hidden'; 
        document.getElementById('code').innerText = code;
        // let's assume that coinbase is our account
        web3.eth.defaultAccount = web3.eth.coinbase;
        // create contract
        document.getElementById('status').innerText = "transaction sent, waiting for confirmation";
        web3.eth.contract(abi).new({data: code}, function (err, contract) {
            if(err) {
                console.error(err);
                return;
            // callback fires twice, we only want the second call when the contract is deployed
            } else if(contract.address){
                myContract = contract;
                console.log('address: ' + myContract.address);
                document.getElementById('status').innerText = 'Mined!';
                document.getElementById('call').style.visibility = 'visible';
            }
        });
    }
    */

    function getPlayers() {
        // this should be generated by ethereum
        var address = (document.getElementById('address').value);

        
        web3.eth.defaultAccount = address;

        console.log(address);
        
        console.log('contract');
        console.log(lotteryContract);

        
        console.log(lotteryContractInstance);
        
        console.log('getPlayers');
        lotteryContractInstance.getPlayers(function(error, result) {
            console.log('insidePlayers');
            //console.log(error);
            console.log(result);
            //0x00557AcaFfd656eC3D515577f2022F85514A251B
            if (!error) {
                console.log('AA');
                var a = result;
                var res = [];
                a.forEach(function(entry) {
                    res += {'address': entry};
                    console.log(entry);
                });
                console.log('BB');

                console.log(JSON.stringify(res));
                console.log((res));
                var arr = [];
                var len = result.length;
                for (var i = 0; i < len; i++) {
                    arr.push({
                        address: result[i]
                    });
                }
                console.log('CC');
                console.log(arr)

                $('#players').bootstrapTable({
                    columns: [{
                        field: 'address',
                        title: 'Address'
                    }],
                    data: arr/*[{
                        address: '123lk4j23lk4k23j4l23j423'
                    }, {
                        address: '095agjvmsosfp6i3w40tgsigj'
                    }]*/
                });

                return result;
            } else {
                //return [];
            }
        });
    }

    function buyLottery() {
        // this should be generated by ethereum
        var address = (document.getElementById('address').value);

        //var Web3 = require('web3');
        //var web3 = new Web3();
        //web3 = new Web3(new Web3.providers.HttpProvider("https://rinkeby.infura.io"));

        //console.log('a');
        //var coinbase = web3.eth.coinbase;
        //var balance = web3.eth.getBalance(coinbase);
        web3.eth.defaultAccount = address;
        web3.eth.coinbase = address;
        console.log('eth');
        console.log(web3);
        //miner.setEtherbase(eth.accounts[0])

        console.log('address');
        console.log(address);
        //console.log(balance);

        //var CoursetroContract = web3.eth.contract(PASTE ABI HERE!);

        console.log('contract');
        console.log(lotteryContractInstance);
        //var lotteryContractInstance = lotteryContract.at('0xB166DE9595a42fdE8Ce3572A31Ae0a484C33aaEA');
        //console.log(lotteryContractInstance);
        //console.log(lotteryContractInstance.getPlayers());

        console.log('typeof EthJS:',               (typeof EthJS));
        console.log('Object.keys(EthJS):',         Object.keys(EthJS));
        console.log('typeof EthJS.Tx:',            (typeof EthJS.Tx));
        console.log('typeof EthJS.RLP:',           (typeof EthJS.RLP));
        console.log('typeof EthJS.Util:',          (typeof EthJS.Util));
        console.log('typeof EthJS.Buffer:',        (typeof EthJS.Buffer));
        console.log('typeof EthJS.Buffer.Buffer:', (typeof EthJS.Buffer.Buffer));
        
        
        console.log(web3.eth.getBalance(address));

        privateKey = new EthJS.Buffer.Buffer('4f973b75c3ce33fbd13d5b14400b94e870ebbc9467cf0e06f2aea20215af8163', 'hex');
        // 0xe97dcb62
        web3.eth.getTransactionCount(address, function (err, nonce) {
            // var data = web3.eth.contract(abi).at(address).increment.getData();
            var data = lotteryContractInstance.enter.getData();
            console.log('data');
            console.log(data);

            var gasPrice = web3.eth.gasPrice;
            var gasPriceHex = web3.toHex(gasPrice);
            console.log('eth.getBalance()');
            console.log(web3.eth.defaultAccount);
            
            var ethTransaction = {
                nonce: web3.toHex(nonce),
                //chainId: 8888,
                //gasPrice: '0x64',//100,//gasPriceHex,
                //gasLimit: '0x3E8',//1000,//web3.toHex('2710'),//web3.toHex(web3.toWei('2710000000', 'wei')),
                //gasPrice: web3.toWei(150, 'gwei'),
                from: address,
                to: contract_address,
                //value: 0.015,

                value: web3.toHex(web3.toWei("0.015", "ether")),
                //gasPrice: web3.toHex(2100000), 
                //gas: web3.toHex(2100000000),
                data: data,
                gasPrice: web3.toHex(200), 
                //gasPrice:web3.toWei(60, 'gwei'),
                gasLimit: web3.toHex(100000000000000),
                gas: 100000,
                //value: web3.toWei(0.002, "ether"), gas:21000, gasPrice:web3.toWei(60, 'gwei')}
            };

            console.log('ethTransaction');
            console.log(ethTransaction);
            var tx = new EthJS.Tx(ethTransaction);
            //var feeCost = tx.getUpfrontCost();
            //tx.gas = feeCost;
            //console.log('feeCost');
            //console.log(feeCost);

            /*console.log('value');
            console.log(web3.toHex(0.015));*/
            console.log('tx');
            console.log(tx);
            tx.sign(privateKey);
            //var feeCost = tx.getUpfrontCost();
            //tx.gas = feeCost;

            //console.log('feecost ' + feeCost);

            var raw = '0x' + tx.serialize().toString('hex');
            web3.eth.sendRawTransaction(raw, function (err, transactionHash) {
                console.log('transactionHash');
                console.log(transactionHash);
                console.log(err);
            });
        });

        // 0x26cb0417eAd2D286E8a9d735CcE2a22872ab4e41
        // 4f973b75c3ce33fbd13d5b14400b94e870ebbc9467cf0e06f2aea20215af8163

        /*
        var data = lotteryContractInstance.enter.getData();
        privateKey = new EthJS.Buffer.Buffer('4f973b75c3ce33fbd13d5b14400b94e870ebbc9467cf0e06f2aea20215af8163', 'hex');
        let txParams = {
            nonce:    '0x00',
            gasPrice: '0x09184e72a000', 
            gasLimit: '0x2710',
            from: address,
            //to:       '0x0000000000000000000000000000000000000000', 
            value:    web3.toWei(0.015, 'ether'), //'0x00', 
            data:     data
        };
        let tx = new EthJS.Tx(txParams);
        tx.sign(privateKey);
        let serializedTx = tx.serialize().toString('hex');

        console.log('serializedTx:', serializedTx);
        */

        /*
        console.log('typeof EthJS:',               (typeof EthJS))
        console.log('Object.keys(EthJS):',         Object.keys(EthJS))
        console.log('typeof EthJS.Tx:',            (typeof EthJS.Tx))
        console.log('typeof EthJS.RLP:',           (typeof EthJS.RLP))
        console.log('typeof EthJS.Util:',          (typeof EthJS.Util))
        console.log('typeof EthJS.Buffer:',        (typeof EthJS.Buffer))
        console.log('typeof EthJS.Buffer.Buffer:', (typeof EthJS.Buffer.Buffer))

        {
          let privateKey = new EthJS.Buffer.Buffer('e331b6d69882b4cb4ea581d88e0b604039a3de5967688d3dcffdd2270c0fd109', 'hex')
          let txParams = {
            nonce:    '0x00',
            gasPrice: '0x09184e72a000', 
            gasLimit: '0x2710',
            to:       '0x0000000000000000000000000000000000000000', 
            value:    '0x00', 
            data:     '0x7f7465737432000000000000000000000000000000000000000000000000000000600057'
          }
          let tx = new EthJS.Tx(txParams)
          tx.sign(privateKey)
          let serializedTx = tx.serialize().toString('hex')

          console.log('serializedTx:', serializedTx)
        }

        */
        console.log(web3);
        console.log('enter');
        //const privateKey = '4f973b75c3ce33fbd13d5b14400b94e870ebbc9467cf0e06f2aea20215af8163';
        //var privateKey = new Buffer('4f973b75c3ce33fbd13d5b14400b94e870ebbc9467cf0e06f2aea20215af8163', 'hex');
        //const account = web3.eth.accounts.privateKeyToAccount('0x' + privateKey);
        //console.info(account.address);
        //{from: address, gas: 3000000, value: 0.015}
        /*var password = 'Mozcorp00!';
        web3.personal.unlockAccount(web3.eth.defaultAccount, password, 600)
            .then((response) => {
                console.log(response);
            }).catch((error) => {
                console.log(error);
            });*/
        //console.log(helloWorldContractInstance.sayHi.call());

        /*
        lotteryContractInstance.enter.call({
            from: web3.eth.defaultAccount, 
            value: web3.toWei(0.015, 'ether')
        });
        */
        /*
        var data = lotteryContractInstance.enter.getData();
        console.log('data');
        console.log(data);

        // So now we have created a blank transaction but Its not quiet valid yet. We
        // need to add some things to it. Lets start:
        // notice we don't set the `to` field because we are creating a new contract.
        tx.nonce = 0;
        tx.gasPrice = 100;
        tx.gasLimit = 1000;
        tx.value = 0.015;
        tx.data = data;//'0x7f4e616d65526567000000000000000000000000000000000000000000000000003057307f4e616d6552656700000000000000000000000000000000000000000000000000573360455760415160566000396000f20036602259604556330e0f600f5933ff33560f601e5960003356576000335700604158600035560f602b590033560f60365960003356573360003557600035335700';

        var privateKey = new Buffer('e331b6d69882b4cb4ea581d88e0b604039a3de5967688d3dcffdd2270c0fd109', 'hex');
        tx.sign(privateKey);
        // We have a signed transaction, Now for it to be fully fundable the account that we signed
        // it with needs to have a certain amount of wei in to. To see how much this
        // account needs we can use the getUpfrontCost() method.
        var feeCost = tx.getUpfrontCost();
        tx.gas = feeCost;
        console.log('Total Amount of wei needed:' + feeCost.toString());
        */
        /*
        var tx = new ethereumjs.Tx({
          nonce: web3.toHex(web3.toWei('20000', 'gwei')),
          gasPrice: web3.toHex(web3.toWei('20000', 'gwei')),
          gasLimit: 1000000,
          from: address,
          to: contract_address,
          value: web3.toWei(0.015, 'ether'),
          data: data,
        });
        tx.sign(ethereumjs.Buffer.Buffer.from(privateKey, 'hex'));

        var raw = '0x' + tx.serialize().toString('hex');
        web3.eth.sendRawTransaction(raw, function (err, transactionHash) {
            console.log('sendRawTransaction');
            console.log(err);
            console.log(transactionHash);
        });
        */

        //lotteryContractInstance.enter.call({from: address, value: 0.015});
        /*, function(error, result) {
            //console.log(JSON.stringify(error));
            //console.log(result);
            if (!error) {
                //$("#instructor").html(result[0]+' ('+result[1]+' years old)');
                console.log(result);
            } else {
                console.log(JSON.stringify(error));
            }
        });

        */
    }

    function pickWinner() {

        var address = (document.getElementById('address').value);
        web3.eth.defaultAccount = address;

        console.log(address);

        //var lotteryContractInstance = lotteryContract.at('0xB166DE9595a42fdE8Ce3572A31Ae0a484C33aaEA');
        
        $('#winner').text('11');
        lotteryContractInstance.pickWinner(function(error, result) {
            console.log(error);
            console.log(result);
            if (!error) {
                console.log(result);
            } else {
                console.error(error);
            }
        });
    }
</script>
</head>

<body>

    <h1>Simple Lottery</h1>

    <div id="status"></div>

    <!--
    <div id='create'>
        <button type="button" onClick="createExampleContract();">create example contract</button>
    </div>
    -->

    <div id='call'>
        <label>Address</label>
        <input type="text" id="address"></input>
    </div>

    <br />
    <button onclick="buyLottery()">
        Buy Lottery Ticket
    </button>
    <br />
    <button onclick="pickWinner()">
        Pick Winner
    </button>
    <br />
    <button onclick="getPlayers()">
        Show Players
    </button>
    <br />

    <div class="row" id="result">
        <h2>Winner</h2>
        <span id="winner"></span>
    </div>

    <div class="row">
        <h2>Players</h2>

        <table id="players"></table>

    </div>
</body>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>

<!-- Latest compiled and minified JavaScript -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-table/1.12.1/bootstrap-table.min.js"></script>

<!-- Latest compiled and minified Locales -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-table/1.12.1/locale/bootstrap-table-zh-CN.min.js"></script>
<script>

//var players = getPlayers();
//console.log('players');
//console.log(players);

</script>
</html>

